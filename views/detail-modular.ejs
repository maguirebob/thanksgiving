<!-- Back Navigation -->
<div class="mb-4">
    <a href="/" class="btn-view-details" style="background-color: var(--secondary-gray);">
        <i class="fas fa-arrow-left me-2"></i>
        Back to All Menus
    </a>
</div>

<!-- Menu Detail Layout -->
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Menu Header -->
        <div class="mb-4">
            <div class="menu-date"><%= new Date(event.event_date).toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }) %></div>
            <h1 class="menu-title" style="font-size: 3rem; margin-bottom: 1rem;"><%= event.event_name %></h1>
            <div class="menu-location" style="font-size: 1.1rem; margin-bottom: 2rem;"><%= event.event_location %></div>
        </div>

        <!-- Menu Image -->
        <div class="mb-5">
            <div class="menu-image-container" style="height: 600px; border-radius: 8px; background-color: #f8f9fa; border: 1px solid #e5e5e5; display: flex; align-items: center; justify-content: center; padding: 2rem; position: relative; overflow: hidden;">
                <img src="<%= event.menu_image_url %>" 
                     alt="<%= event.event_name %>" 
                     id="menuImage"
                     style="max-width: 100%; max-height: 100%; object-fit: contain; object-position: center; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: zoom-in; transition: transform 0.3s ease;"
                     onerror="this.src='/images/placeholder-menu.jpg'"
                     onclick="toggleZoom()">
                
                <!-- Zoom overlay -->
                <div id="zoomOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; cursor: zoom-out;" onclick="toggleZoom()">
                    <img src="<%= event.menu_image_url %>" 
                         alt="<%= event.event_name %>" 
                         style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;"
                         onerror="this.src='/images/placeholder-menu.jpg'">
                </div>
            </div>
            
            <!-- Image controls -->
            <div class="text-center mt-3">
                <button class="btn-view-details" onclick="toggleZoom()" style="margin-right: 1rem;">
                    <i class="fas fa-search-plus me-2"></i>
                    Zoom Image
                </button>
                <button class="btn-view-details" onclick="downloadImage()" style="background-color: var(--secondary-gray);">
                    <i class="fas fa-download me-2"></i>
                    Download Image
                </button>
            </div>
        </div>

        <!-- Menu Description -->
        <div class="mb-5">
            <h2 class="section-title" style="font-size: 2rem; border-bottom: 2px solid var(--accent-orange); margin-bottom: 1rem;">About This Menu</h2>
            <p style="font-size: 1.1rem; line-height: 1.6; color: var(--primary-black);"><%= event.description %></p>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Event Info Card -->
        <div class="card mb-4" style="border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div class="card-header" style="background: linear-gradient(135deg, var(--accent-orange), #e67e22); color: white; border: none;">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Event Details</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Date:</strong><br>
                    <%= new Date(event.event_date).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) %>
                </div>
                <div class="mb-3">
                    <strong>Location:</strong><br>
                    <%= event.event_location %>
                </div>
                <div class="mb-3">
                    <strong>Type:</strong><br>
                    <%= event.event_type || 'Thanksgiving' %>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card" style="border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div class="card-header" style="background: linear-gradient(135deg, var(--primary-black), #2c3e50); color: white; border: none;">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn-view-details" onclick="shareMenu()">
                        <i class="fas fa-share-alt me-2"></i>
                        Share Menu
                    </button>
                    <button class="btn-view-details" style="background-color: var(--secondary-gray);" onclick="printMenu()">
                        <i class="fas fa-print me-2"></i>
                        Print Menu
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photos Section -->
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="section-title" style="font-size: 2rem; border-bottom: 2px solid var(--accent-orange); margin-bottom: 0;">Photos</h2>
        <div class="d-flex gap-2">
            <button class="btn-view-details" onclick="photoManager.openUploadModal()" id="uploadPhotoBtn">
                <i class="fas fa-upload me-2"></i>
                Upload Photo
            </button>
            <button class="btn-view-details" onclick="photoManager.openCameraModal()" id="capturePhotoBtn" style="background-color: var(--secondary-gray);">
                <i class="fas fa-camera me-2"></i>
                Take Photo
            </button>
        </div>
    </div>
    
    <!-- Photos Grid -->
    <div id="photosGrid" class="row">
        <!-- Photos will be loaded here dynamically -->
    </div>
    
    <!-- No photos message -->
    <div id="noPhotosMessage" class="text-center py-5" style="display: none;">
        <i class="fas fa-images" style="font-size: 3rem; color: var(--secondary-gray); margin-bottom: 1rem;"></i>
        <h3 style="color: var(--secondary-gray);">No photos yet</h3>
        <p style="color: var(--secondary-gray);">Upload or take photos to capture memories from this Thanksgiving!</p>
    </div>
</div>

<!-- Photo Upload Modal -->
<div id="photoUploadModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="color: var(--primary-black); margin-bottom: 1rem; font-family: 'Playfair Display', Georgia, serif;">
            <i class="fas fa-upload me-2"></i>
            Upload Photo
        </h3>
        
        <form id="photoUploadForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="photoFile" class="form-label">Select Photo</label>
                <input type="file" class="form-control" id="photoFile" accept="image/*" required>
            </div>
            
            <div class="mb-3">
                <label for="photoDescription" class="form-label">Description</label>
                <textarea class="form-control" id="photoDescription" rows="3" placeholder="Describe this photo..."></textarea>
            </div>
            
            <div class="mb-3">
                <label for="photoCaption" class="form-label">Caption</label>
                <input type="text" class="form-control" id="photoCaption" placeholder="Short caption for this photo">
            </div>
            
            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn-view-details" style="background-color: var(--secondary-gray);" onclick="photoManager.closeUploadModal()">
                    <i class="fas fa-times me-2"></i>
                    Cancel
                </button>
                <button type="submit" class="btn-view-details">
                    <i class="fas fa-upload me-2"></i>
                    Upload Photo
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Camera Capture Modal -->
<div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 800px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="color: var(--primary-black); margin-bottom: 1rem; font-family: 'Playfair Display', Georgia, serif;">
            <i class="fas fa-camera me-2"></i>
            Take Photo
        </h3>
        
        <div class="mb-3">
            <video id="cameraVideo" autoplay style="width: 100%; max-height: 400px; border-radius: 8px; background: #000;"></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <img id="capturedImagePreview" style="display: none; width: 100%; max-height: 400px; border-radius: 8px; object-fit: cover;" alt="Captured photo">
        </div>
        
        <div class="mb-3">
            <label for="captureDescription" class="form-label">Description</label>
            <textarea class="form-control" id="captureDescription" rows="2" placeholder="Describe this photo..."></textarea>
        </div>
        
        <div class="mb-3">
            <label for="captureCaption" class="form-label">Caption</label>
            <input type="text" class="form-control" id="captureCaption" placeholder="Short caption for this photo">
        </div>
        
        <div class="d-flex gap-2 justify-content-center">
            <button type="button" class="btn-view-details" onclick="photoManager.startCamera()" id="startCameraBtn">
                <i class="fas fa-video me-2"></i>
                Start Camera
            </button>
            <button type="button" class="btn-view-details" onclick="photoManager.capturePhoto()" id="captureBtn" style="display: none;">
                <i class="fas fa-camera me-2"></i>
                Capture
            </button>
            <button type="button" class="btn-view-details" onclick="photoManager.saveCapturedPhoto()" id="saveBtn" style="display: none;">
                <i class="fas fa-save me-2"></i>
                Save Photo
            </button>
            <button type="button" class="btn-view-details" style="background-color: var(--secondary-gray);" onclick="photoManager.closeCameraModal()">
                <i class="fas fa-times me-2"></i>
                Close
            </button>
        </div>
    </div>
</div>

<!-- Photo Edit Modal -->
<div id="photoEditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="color: var(--primary-black); margin-bottom: 1rem; font-family: 'Playfair Display', Georgia, serif;">
            <i class="fas fa-edit me-2"></i>
            Edit Photo
        </h3>
        
        <form id="photoEditForm">
            <div class="mb-3">
                <label for="editDescription" class="form-label">Description</label>
                <textarea class="form-control" id="editDescription" rows="3" placeholder="Describe this photo..."></textarea>
            </div>
            
            <div class="mb-3">
                <label for="editCaption" class="form-label">Caption</label>
                <input type="text" class="form-control" id="editCaption" placeholder="Short caption for this photo">
            </div>
            
            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn-view-details" style="background-color: var(--secondary-gray);" onclick="photoManager.closeEditModal()">
                    <i class="fas fa-times me-2"></i>
                    Cancel
                </button>
                <button type="submit" class="btn-view-details">
                    <i class="fas fa-save me-2"></i>
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Scripts -->
<script src="/javascript/photoManager.js"></script>
<script src="/javascript/photoApiClient.js"></script>
<script src="/javascript/fileUtils.js"></script>
<script src="/javascript/errorHandler.js"></script>

<script>
// Initialize Photo System
let photoManager;

document.addEventListener('DOMContentLoaded', function() {
    // Get auth token
    const authToken = getAuthToken();
    
    // Initialize photo manager
    photoManager = new PhotoManager(<%= event.id %>, authToken);
    
    // Load photos
    photoManager.loadPhotos();
    
    // Setup event listeners
    setupPhotoEventListeners();
});

function setupPhotoEventListeners() {
    // Photo upload form
    document.getElementById('photoUploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await photoManager.handleFileUpload(e);
    });
    
    // Photo edit form
    document.getElementById('photoEditForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await photoManager.handlePhotoEdit(e);
    });
}

// Utility functions
function getAuthToken() {
    // Try to get token from localStorage first
    const token = localStorage.getItem('authToken');
    if (token) return token;
    
    // Fallback to cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'authToken') return value;
    }
    
    return null;
}

// Image zoom functionality
function toggleZoom() {
    const overlay = document.getElementById('zoomOverlay');
    overlay.style.display = overlay.style.display === 'none' ? 'flex' : 'none';
}

// Download image functionality
function downloadImage() {
    const img = document.getElementById('menuImage');
    const link = document.createElement('a');
    link.href = img.src;
    link.download = '<%= event.event_name %>.jpg';
    link.click();
}

// Share menu functionality
function shareMenu() {
    if (navigator.share) {
        navigator.share({
            title: '<%= event.event_name %>',
            text: 'Check out this Thanksgiving menu!',
            url: window.location.href
        });
    } else {
        // Fallback to copying URL
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Menu URL copied to clipboard!');
        });
    }
}

// Print menu functionality
function printMenu() {
    window.print();
}
</script>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">Admin Dashboard</h1>
      
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Total Users</h5>
              <h2 class="text-primary"><%= stats.totalUsers %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Total Events</h5>
              <h2 class="text-success"><%= stats.totalEvents %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Total Photos</h5>
              <h2 class="text-info"><%= stats.totalPhotos %></h2>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Events -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Recent Events</h5>
        </div>
        <div class="card-body">
          <% if (recentEvents && recentEvents.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Event Name</th>
                    <th>Date</th>
                    <th>Location</th>
                    <th>Photos</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% recentEvents.forEach(event => { %>
                    <tr>
                      <td>
                        <a href="/menu/<%= event.id %>" class="text-decoration-none">
                          <%= event.event_name %>
                        </a>
                      </td>
                      <td><%= new Date(event.event_date).toLocaleDateString() %></td>
                      <td>Family Home</td>
                      <td>
                        <span class="badge bg-secondary"><%= event.photoCount %></span>
                      </td>
                      <td><%= new Date(event.created_at).toLocaleDateString() %></td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-primary" onclick="editEvent(<%= event.id %>)" title="Edit Event">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-outline-danger" onclick="deleteEvent(<%= event.id %>)" title="Delete Event">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <p class="text-muted">No events found.</p>
          <% } %>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3 mb-2">
                  <a href="/admin/users" class="btn btn-primary w-100">
                    <i class="fas fa-users me-2"></i>
                    Manage Users
                  </a>
                </div>
                <div class="col-md-3 mb-2">
                  <a href="/" class="btn btn-success w-100">
                    <i class="fas fa-home me-2"></i>
                    View Site
                  </a>
                </div>
                <div class="col-md-3 mb-2">
                  <a href="/api/v1/events" class="btn btn-info w-100">
                    <i class="fas fa-code me-2"></i>
                    API Endpoints
                  </a>
                </div>
                <div class="col-md-3 mb-2">
                  <a href="/auth/logout" class="btn btn-warning w-100">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    Logout
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editEventForm">
          <input type="hidden" id="editEventId" name="id">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editEventName" class="form-label">Event Name</label>
              <input type="text" class="form-control" id="editEventName" name="event_name" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="editEventType" class="form-label">Event Type</label>
              <input type="text" class="form-control" id="editEventType" name="event_type" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editEventLocation" class="form-label">Location</label>
              <input type="text" class="form-control" id="editEventLocation" name="event_location" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="editEventDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="editEventDate" name="event_date" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="editMenuTitle" class="form-label">Menu Title</label>
            <input type="text" class="form-control" id="editMenuTitle" name="menu_title" required>
          </div>
          
          <div class="mb-3">
            <label for="editMenuImageUrl" class="form-label">Menu Image URL</label>
            <input type="text" class="form-control" id="editMenuImageUrl" name="menu_image_url" required>
          </div>
          
          <div class="mb-3">
            <label for="editDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editDescription" name="description" rows="4" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveEvent()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Event Modal -->
<div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteEventModalLabel">Delete Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this event? This action cannot be undone and will permanently remove this event from the database.</p>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> This will also delete all associated photos and comments.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeleteEvent()">Delete Event</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentEventId = null;

// Edit event function
async function editEvent(eventId) {
  try {
    // Fetch event data
    const response = await fetch(`/api/v1/events/${eventId}`);
    const result = await response.json();
    
    if (result.success) {
      const event = result.event;
      
      // Populate form
      document.getElementById('editEventId').value = event.id;
      document.getElementById('editEventName').value = event.event_name;
      document.getElementById('editEventType').value = event.event_type || 'Thanksgiving';
      document.getElementById('editEventLocation').value = event.event_location || '';
      document.getElementById('editEventDate').value = new Date(event.event_date).toISOString().split('T')[0];
      document.getElementById('editMenuTitle').value = event.event_name;
      document.getElementById('editMenuImageUrl').value = event.menu_image_url || '';
      document.getElementById('editDescription').value = event.description || '';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('editEventModal'));
      modal.show();
    } else {
      alert('Error loading event: ' + result.message);
    }
  } catch (error) {
    console.error('Error loading event:', error);
    alert('Error loading event. Please try again.');
  }
}

// Save event function
async function saveEvent() {
  try {
    const formData = new FormData(document.getElementById('editEventForm'));
    const updateData = {};
    
    // Convert FormData to object
    for (let [key, value] of formData.entries()) {
      updateData[key] = value;
    }
    
    const eventId = updateData.id;
    delete updateData.id; // Remove id from update data
    
    const response = await fetch(`/api/v1/events/${eventId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(updateData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('editEventModal'));
      modal.hide();
      
      // Show success message
      showMessage('Event updated successfully!', 'success');
      
      // Reload page after a short delay
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      alert('Error updating event: ' + result.message);
    }
  } catch (error) {
    console.error('Error updating event:', error);
    alert('Error updating event. Please try again.');
  }
}

// Delete event function
function deleteEvent(eventId) {
  currentEventId = eventId;
  const modal = new bootstrap.Modal(document.getElementById('deleteEventModal'));
  modal.show();
}

// Confirm delete event function
async function confirmDeleteEvent() {
  if (!currentEventId) return;
  
  try {
    const response = await fetch(`/api/v1/events/${currentEventId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('deleteEventModal'));
      modal.hide();
      
      // Show success message
      showMessage('Event deleted successfully!', 'success');
      
      // Reload page after a short delay
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      alert('Error deleting event: ' + result.message);
    }
  } catch (error) {
    console.error('Error deleting event:', error);
    alert('Error deleting event. Please try again.');
  }
}

// Show message function
function showMessage(message, type) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
  messageDiv.style.position = 'fixed';
  messageDiv.style.top = '20px';
  messageDiv.style.right = '20px';
  messageDiv.style.zIndex = '10000';
  messageDiv.style.minWidth = '300px';
  messageDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(messageDiv);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.parentNode.removeChild(messageDiv);
    }
  }, 5000);
}
</script>

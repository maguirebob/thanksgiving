<!-- Photos Page Content -->

<div class="photos-page">
    <!-- Header -->
    <div class="photos-header">
        <h1 class="photos-title">
            <i class="fas fa-images"></i> Photos Storage
        </h1>
        <p class="photos-subtitle">View all photos stored in S3 cloud storage</p>
    </div>

    <!-- Storage Information -->
    <div class="storage-info-card">
        <h2 class="storage-info-title">
            <i class="fas fa-info-circle"></i> Storage Information
        </h2>
        <div class="storage-info-grid">
            <div class="storage-info-item">
                <div class="storage-info-label">Environment</div>
                <div class="storage-info-value">
                    <span class="storage-status-badge storage-status-success"><%= environment %></span>
                </div>
            </div>
            <div class="storage-info-item">
                <div class="storage-info-label">Storage Type</div>
                <div class="storage-info-value">
                    <code><%= mountPath %></code>
                </div>
            </div>
            <div class="storage-info-item">
                <div class="storage-info-label">S3 Bucket</div>
                <div class="storage-info-value">
                    <code><%= volumeName %></code>
                </div>
            </div>
            <div class="storage-info-item">
                <div class="storage-info-label">Status</div>
                <div class="storage-info-value">
                    <% if (directoryExists) { %>
                        <span class="storage-status-badge storage-status-success">Storage Available</span>
                    <% } else { %>
                        <span class="storage-status-badge storage-status-danger">Storage Unavailable</span>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <% if (directoryExists) { %>
    <div class="photos-stats-grid">
        <div class="photos-stat-card">
            <span class="photos-stat-number"><%= stats.totalFiles %></span>
            <div class="photos-stat-label">Total Files</div>
        </div>
        <div class="photos-stat-card">
            <span class="photos-stat-number"><%= stats.imageFiles %></span>
            <div class="photos-stat-label">Images</div>
        </div>
        <div class="photos-stat-card">
            <span class="photos-stat-number"><%= stats.linkedFiles %></span>
            <div class="photos-stat-label">Linked</div>
        </div>
        <div class="photos-stat-card">
            <span class="photos-stat-number"><%= stats.orphanedFiles %></span>
            <div class="photos-stat-label">Orphaned</div>
        </div>
        <div class="photos-stat-card">
            <span class="photos-stat-number"><%= stats.totalSize %></span>
            <div class="photos-stat-label">Total Size</div>
        </div>
    </div>
    <% } %>

    <!-- Files List -->
    <div class="photos-files-card">
        <div class="photos-files-header">
            <h2 class="photos-files-title">
                <i class="fas fa-folder"></i> Photos Files
            </h2>
            <button type="button" class="photos-refresh-btn" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div class="photos-files-content">
            <% if (!directoryExists) { %>
                <div class="photos-empty-state">
                    <i class="fas fa-exclamation-triangle photos-empty-icon"></i>
                    <h3 class="photos-empty-title">Photos Storage Not Available</h3>
                    <p class="photos-empty-message">Photos are stored in S3 cloud storage: <code><%= mountPath %></code></p>
                    <p class="photos-empty-message">This may be normal if no photos have been uploaded yet.</p>
                </div>
            <% } else if (files.length === 0) { %>
                <div class="photos-empty-state">
                    <i class="fas fa-images photos-empty-icon"></i>
                    <h3 class="photos-empty-title">No Photos Found</h3>
                    <p class="photos-empty-message">The photos storage is empty.</p>
                </div>
            <% } else { %>
                <table class="photos-table">
                    <thead>
                        <tr>
                            <th>Preview</th>
                            <th>Filename</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Status</th>
                            <th>Modified</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% files.forEach(file => { %>
                        <tr>
                            <td>
                                <% if (file.type === 'image') { %>
                                    <img src="/api/photos/<%= file.name %>/preview" 
                                         class="photo-preview" 
                                         alt="<%= file.name %>"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyMEg0MFY0MEgyMFYyMFoiIGZpbGw9IiNEOUQ5RDkiLz4KPC9zdmc+Cg=='">
                                <% } else { %>
                                    <div class="photo-preview-placeholder">
                                        <i class="fas fa-file"></i>
                                    </div>
                                <% } %>
                            </td>
                            <td>
                                <code class="photo-filename"><%= file.name %></code>
                            </td>
                            <td>
                                <span class="photo-type-badge"><%= file.type %></span>
                            </td>
                            <td>
                                <%= (file.size / 1024).toFixed(1) %> KB
                            </td>
                            <td>
                                <% if (file.isLinked) { %>
                                    <span class="photo-status-linked">
                                        <i class="fas fa-link"></i> Linked
                                    </span>
                                <% } else { %>
                                    <span class="photo-status-orphaned">
                                        <i class="fas fa-unlink"></i> Orphaned
                                    </span>
                                <% } %>
                            </td>
                            <td>
                                <%= new Date(file.modified).toLocaleDateString() %>
                            </td>
                            <td>
                                <div class="photo-actions">
                                    <% if (file.type === 'image') { %>
                                        <button class="photo-action-btn photo-action-btn-primary" 
                                                onclick="viewPhoto('<%= file.name %>')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    <% } %>
                                    <% if (!file.isLinked) { %>
                                        <button class="photo-action-btn photo-action-btn-danger" 
                                                onclick="deleteFile('<%= file.name %>')"
                                                title="Delete orphaned photo">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    <% } else { %>
                                        <span class="photo-action-btn photo-action-btn-secondary" 
                                              title="Cannot delete linked photos"
                                              style="background-color: #6c757d; color: white; cursor: not-allowed;">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    <% } %>
                                </div>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } %>
        </div>
    </div>
</div>

<!-- Photo Viewer Modal -->
<div class="modal fade" id="photoViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoViewerModalLabel">Photo Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="photoViewerImg" class="img-fluid" alt="Photo">
            </div>
        </div>
    </div>
</div>

<script>
    function viewPhoto(filename) {
        const img = document.getElementById('photoViewerImg');
        img.src = `/api/photos/${filename}/preview`;
        const modal = new bootstrap.Modal(document.getElementById('photoViewerModal'));
        modal.show();
    }
    
    function deleteFile(filename) {
        if (confirm(`Are you sure you want to delete ${filename}?`)) {
            // Call the delete API endpoint
            fetch(`/api/photos/${filename}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message and reload the page
                    alert('Photo deleted successfully');
                    location.reload();
                } else {
                    // Show error message
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                alert('Failed to delete photo. Please try again.');
            });
        }
    }
</script>
